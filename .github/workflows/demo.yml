# workflowçš„åç§°ï¼Œä¼šæ˜¾ç¤ºåœ¨github çš„é¡¹ç›®çš„Actionsçš„å³è¾¹åˆ—è¡¨ä¸­ï¼Œå¦‚ä¸‹å›¾
name: AirDrop Demo Actions

# åœ¨æ»¡è¶³ä»¥ä¸‹æ¡ä»¶è§¦å‘è¿™ä¸ªworkflow
on: [push]
 
      
# workflowçš„æ‰€æœ‰ä½œä¸šjob
jobs:
  Explore-GitHub-Actions:
    runs-on: ubuntu-latest
    steps:
      - run: echo "ğŸ‰ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "ğŸ§ This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "ğŸ” The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v3
      - run: echo "ğŸ’¡ The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "ğŸ–¥ï¸ The workflow is now ready to test your code on the runner."
      - name: List files in the repository
        run: |
          ls ${{ github.workspace }}
      - run: echo "ğŸ This job's status is ${{ job.status }}."
  
  test:
    # testè¿™ä¸ªä½œä¸šçš„å®é™…åå­—
    # ä¹Ÿæ˜¯æ‰§è¡Œbuildæ—¶Actionsç›‘æ§å¤„æ˜¾ç¤ºçš„åå­—
    name: Run Unit Tests
    # jobçš„è¿è¡Œå¹³å°ï¼Œè¿˜æœ‰windowsã€macosåŠä¸åŒç‰ˆæœ¬å¯ä¾›é€‰æ‹©
    runs-on: ubuntu-18.04
    # testä»»åŠ¡çš„å…·ä½“æ­¥éª¤ï¼Œå¯ä»¥æœ‰å¾ˆå¤šä¸ªæ­¥éª¤ï¼Œéƒ½å†™åœ¨è¿™é‡Œ
    steps:
      # ä½¿ç”¨åˆ«äººå†™å¥½çš„æŒ‡å®šç‰ˆæœ¬çš„actionsè„šæœ¬ï¼Œåç§°æ˜¯checkout
      # è¿™æ˜¯æ­¥éª¤1ï¼Œå³æ¯ä¸ª'-'ç¬¦å·åˆ°ä¸‹ä¸€ä¸ª'-'ç¬¦å·ä¹‹é—´çš„éƒ¨åˆ†æ˜¯ä¸€ä¸ªæ­¥éª¤
      - uses: actions/checkout@v2
      # è¿™æ˜¯æ­¥éª¤2ï¼Œåˆ›å»ºjavaç¯å¢ƒï¼Œwithé‡Œé¢å¡«å†™actionsçš„è¾“å…¥å‚æ•°
      - name: set up JDK 1.8
        uses: actions/setup-java@v1
        # è®¾ç½®setup-javaè„šæœ¬çš„è¾“å…¥å‚æ•°
        with:
          java-version: 1.8
      # æ­¥éª¤3ï¼Œæ‰§è¡Œshellå‘½ä»¤
      - name: Unit tests
        run: bash ./gradlew test --stacktrace

  apk:
    name: Generate APK
    runs-on: ubuntu-18.04

    steps:
      - uses: actions/checkout@v2
      - name: set up JDK 1.8
        uses: actions/setup-java@v1
        with:
          java-version: 1.8
      - name: Build debug APK
        run: bash ./gradlew assembleDebug --stacktrace
      # åˆ©ç”¨upload-artifactå®ç°buildç»“æœçš„ä¿å­˜ï¼ˆå¯ä»¥åœ¨Actionsçš„æ§åˆ¶å°ä¸‹è½½å‹ç¼©æ–‡ä»¶ï¼‰
      - name: Upload APK
        uses: actions/upload-artifact@v2
        with:
          # è®¾ç½®å‹ç¼©æ–‡ä»¶çš„åç§°ï¼Œåœ¨æ§åˆ¶å°ä¼šå¾—åˆ°WhuHelper-debug.zipæ–‡ä»¶çš„ä¸‹è½½é“¾æ¥
          # ä¸‹è½½åè§£å‹ç¼©ï¼Œé‡Œé¢ç›´æ¥å¯ä»¥çœ‹åˆ°app-debug.apkï¼Œæ²¡æœ‰å…¶ä»–ä¸œè¥¿
          name: WhuHelper-debug
          path: app/build/outputs/apk/debug/app-debug.apk

  deploy:
    name: Upload Release Asset
    # ä¾èµ–ä¸Šä¸€ä¸ªjob
    needs: apk
    runs-on: ubuntu-latest
    # åªåœ¨tagæ—¶æ‰§è¡Œï¼Œå³åœ¨è‡ªå·±ç»ˆç«¯è¿è¡Œä»¥ä¸‹ä»£ç åæ‰ä¼šè§¦å‘
    # git tag -a v0.1.0 -m "release 0.1.0 version"
    # git push origin â€“-tags
    if: contains(github.ref, 'tags/')
    steps:
      # è‡ªå·±ç¼–å†™çš„shellå‘½ä»¤
      # å­¦ä¹ å¦‚ä½•è®¾ç½®å•ä¸ªä»»åŠ¡çš„è¾“å‡ºæ¥è¢«å…¶ä»–ä»»åŠ¡è°ƒç”¨
      - name: Prepare Release
        # è®¾ç½®idä¸€èˆ¬æ˜¯ä¸ºäº†å…¶ä»–stepè°ƒç”¨æœ¬æ­¥éª¤çš„è¾“å‡º
        id: prepare_release
        run: |
          TAG_NAME=`echo $GITHUB_REF | cut -d / -f3`
          echo ::set-output name=tag_name::$TAG_NAME
      - name: Download build result for job apk
        # åªæœ‰ä¸Šä¸€æ­¥è·å–åˆ°tag_nameæ‰ç»§ç»­ï¼Œä¸‹è½½å‰é¢apkä»»åŠ¡é‡Œé¢çš„WhuHelper-debug.zipæ–‡ä»¶
        # è‡ªåŠ¨è§£å‹ç¼©åˆ°å½“å‰æ–‡ä»¶å¤¹ï¼Œè‡ªåŠ¨åˆ é™¤åŸå‹ç¼©æ–‡ä»¶
        # å¤šä»»åŠ¡ä¹‹é—´çš„æ•°æ®äº¤æ¢
        if: steps.prepare_release.outputs.tag_name
        uses: actions/download-artifact@v2
        with:
          name: WhuHelper-debug
      - shell: bash
        # æ‰‹åŠ¨æ›´æ”¹apkåå­—
        run: |
          mv app-debug.apk  app-debug-${{steps.prepare_release.outputs.tag_name}}.apk 
      # å‘å¸ƒreleaseï¼Œç‰ˆæœ¬å·æ˜¯ç”¨æˆ·git pushçš„tagé‡Œé¢çš„ç‰ˆæœ¬å·ï¼Œå‘å¸ƒçš„åªæœ‰ä»£ç å‹ç¼©åŒ…ï¼ˆä¸æ‰‹åŠ¨é»˜è®¤å‘å¸ƒä¸€è‡´ï¼‰
      - name: Create Release
        id: create_release
        # åªæœ‰ä¸Šä¸€æ­¥è·å–åˆ°tag_nameæ‰ç»§ç»­
        if: steps.prepare_release.outputs.tag_name
        uses: actions/create-release@v1
        env:
          # GitHub ä¼šè‡ªåŠ¨åˆ›å»º GITHUB_TOKEN å¯†ç ä»¥åœ¨å·¥ä½œæµç¨‹ä¸­ä½¿ç”¨
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # è®¾ç½®æ—¶åŒºï¼Œé»˜è®¤æ˜¯æ ¼æ—å°¼æ²»æ—¶é—´
          # TZ: Asia/Shanghai
        with:
          tag_name: ${{steps.prepare_release.outputs.tag_name}}
          release_name: Release ${{steps.prepare_release.outputs.tag_name}} by zfb
          draft: false
          prerelease: false
      # è¿™ä¸€æ­¥æ˜¯å¯¹ä¸Šä¸€æ­¥å‘å¸ƒçš„releaseæ–‡ä»¶çš„è¡¥å……ï¼Œè°ƒç”¨github apiä¸Šä¼ ä¸€ä¸ªapkæ–‡ä»¶
      - name: Upload Release Asset
        id: upload-release-asset 
        # åªæœ‰create_releaseæˆåŠŸå¾—åˆ°è¾“å‡ºæ‰ç»§ç»­
        if: steps.create_release.outputs.upload_url
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }} 
          asset_path: ./app-debug-${{steps.prepare_release.outputs.tag_name}}.apk
          asset_name: app-debug-${{steps.prepare_release.outputs.tag_name}}.apk
          asset_content_type: application/vnd.android.package-archive
